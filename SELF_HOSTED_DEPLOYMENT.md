# Self-Hosted Deployment Guide

This guide will help you deploy Skald on your own infrastructure using Docker Compose. It should only take 15 minutes or so.

By default this deployment will spin up all the services you need to run Skald, but if you intend to run it in production you should ideally deploy Postgres and potentially RabbitMQ separately.

## Quickstart

The fastest way to just try Skald out is with a simple local deploy.

### 1. Clone the repo

```sh
git clone https://github.com/skaldlabs/skald
cd skald
```

### 2. Set up a .env file

The quickest way to get started is to just provide an OpenAI key via the `OPENAI_API_KEY` env var. That's all that should be required to run Skald.

However, you can also configure:

-  `LLM_PROVIDER` (`openai`, `anthropic`, or `local`) and pass in the corresponding vars for the selected provider.
-  `EMBEDDING_PROVIDER` (`openai` or `voyage`) and also pass the appropriate vars. We default to `openai` for this deployment but we ourselves use `voyage` in our Cloud version.

```sh
# .env.dev

LLM_PROVIDER="<openai|anthropic|voyage>"

OPENAI_API_KEY="<your_openai_key>"
ANTHROPIC_API_KEY="<your_anthropic_api_key>"

EMBEDDING_PROVIDER="<openai|voyage>"

VOYAGE_API_KEY="<your_voyage_api_key>"
```

### 3. Start the stack

```sh
# add -d to run in detached mode
docker-compose --env-file .env.dev up
```

Once the build is done you should be able to access `http://localhost:3000` on your browser to access the Skald UI, and `http://localhost:8000` will be your API URL.

## Production deployment

### Pre-requisites

1. A Linux server (x86) with [Docker](https://docs.docker.com/engine/install/ubuntu/) and [Docker Compose](https://docs.docker.com/compose/install/linux/) installed
2. Two domain names (or subdomains) pointing to your server's IP address:
   - One for the API (e.g., `api.yourdomain.com`)
   - One for the UI (e.g., `app.yourdomain.com`)
3. Ports 80 and 443 open on your server

### DNS Configuration

Before running the deployment, ensure the following DNS records are configured:

1. Create an A record for your API domain pointing to your server's IP address
2. Create an A record for your UI domain pointing to your server's IP address

Example DNS configuration:
```
skald-api.yourdomain.com    A    123.456.789.0
skald.yourdomain.com        A    123.456.789.0
```

### Deployment

Clone the Skald repo:

```bash
git clone https://github.com/skaldlabs/skald
```

And then from inside the directory, run the deployment setup script:

```bash
./bin/deploy.sh
```

The script will:

1. Prompt you for your API and UI domain names
2. Request an email address (required for Let's Encrypt SSL certificates)
3. Prompt you for environment variables such as your OpenAI API key
4. Verify your DNS configuration
5. Generate secure credentials
6. Set up a .env.prod file to be used when deploying the stack

After you're done with the setup, run the following command to start the stack in detached mode:

```sh
docker compose -f docker-compose.selfhosted.yml --env-file .env.prod up -d
```

### Managing Your Deployment

#### View logs

```bash
docker compose -f docker-compose.selfhosted.yml logs -f
```

View logs for a specific service:
```bash
docker compose -f docker-compose.selfhosted.yml logs -f api
```

#### Stop the deployment

```bash
docker compose -f docker-compose.selfhosted.yml down
```

#### Restart the deployment

```bash
docker compose -f docker-compose.selfhosted.yml --env-file .env.prod up -d
```

#### Update the deployment

To update to the latest version:

```bash
# Pull the latest images from DockerHub
docker compose -f docker-compose.selfhosted.yml --env-file .env.prod pull

# Restart services with the new images
docker compose -f docker-compose.selfhosted.yml --env-file .env.prod up -d
```

The deployment uses pre-built images from DockerHub, so you don't need to build anything locally.

### What Gets Deployed

The deployment includes:

- **Traefik**: Reverse proxy with automatic SSL certificate generation
- **PostgreSQL with pgvector**: Our database. pgvector support is needed for vector embeddings
- **RabbitMQ**: Used for communicating between the Django server and the Memo Processing Server
- **API**: The main Skald API Django server
- **Memo Processing Server**: Background worker for processing memos
- **UI**: The web interface

### Configuration

All configuration is stored in `.env.prod`, which is automatically generated by the deployment script. This file contains:

- Domain names
- Database credentials
- API keys
- Security secrets

**Important**: Keep this file secure and never commit it to version control.

### SSL Certificates

SSL certificates are automatically generated and renewed by Let's Encrypt through Traefik. The certificates are stored in a Docker volume (`traefik-certificates`) and will auto-renew before expiration.

### Troubleshooting

#### SSL certificate issues

If you're having trouble with SSL certificates:

1. Ensure ports 80 and 443 are open
2. Verify DNS records are pointing to the correct IP
3. Check Traefik logs: `docker compose -f docker-compose.selfhosted.yml logs traefik`
4. Wait a few minutes - certificate generation can take time

#### Service won't start

1. Check service logs: `docker compose -f docker-compose.selfhosted.yml logs <service-name>`
2. Ensure all required environment variables are set in `.env.prod`
3. Verify database is healthy: `docker compose -f docker-compose.selfhosted.yml ps`

#### Cannot connect to API

1. Verify DNS is resolving correctly: `dig your-api-domain.com`
2. Check API logs: `docker compose -f docker-compose.selfhosted.yml logs api`
3. Ensure Traefik is running: `docker compose -f docker-compose.selfhosted.yml ps traefik`

### Security Considerations

1. **Firewall**: Only expose ports 80 and 443 to the internet
2. **Updates**: Regularly update Docker images and rebuild services
3. **Backups**: Backup the `postgres_data` volume regularly
4. **Credentials**: Rotate database passwords periodically
5. **API Keys**: Store sensitive API keys securely in `.env.prod`

### Data Persistence

Data is persisted in Docker volumes:

- `postgres_data`: Database files
- `traefik-certificates`: SSL certificates

To backup your data:
```bash
docker run --rm -v skald2_postgres_data:/data -v $(pwd):/backup ubuntu tar czf /backup/postgres-backup.tar.gz /data
```

To restore:
```bash
docker run --rm -v skald2_postgres_data:/data -v $(pwd):/backup ubuntu tar xzf /backup/postgres-backup.tar.gz -C /
```

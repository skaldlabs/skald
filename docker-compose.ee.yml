services:
    traefik:
        image: traefik:v2.11
        command:
            - '--api.dashboard=false'
            - '--providers.docker=true'
            - '--providers.docker.exposedbydefault=false'
            - '--providers.docker.network=skald_web'
            - '--entrypoints.web.address=:80'
            - '--entrypoints.websecure.address=:443'
            - '--certificatesresolvers.letsencrypt.acme.httpchallenge=true'
            - '--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web'
            - '--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}'
            - '--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json'
            # HTTP to HTTPS redirect
            - '--entrypoints.web.http.redirections.entryPoint.to=websecure'
            - '--entrypoints.web.http.redirections.entryPoint.scheme=https'
            - '--log.level=DEBUG'
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - traefik-certificates:/letsencrypt
        restart: unless-stopped
        networks:
            - web

    db:
        image: pgvector/pgvector:pg16
        environment:
            POSTGRES_DB: ${POSTGRES_DB:-skald2}
            POSTGRES_USER: ${POSTGRES_USER:-postgres}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./docker-init:/docker-entrypoint-initdb.d
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U postgres']
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - backend

    rabbitmq:
        image: rabbitmq:3.13-management-alpine
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-skald}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-skald}
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
        healthcheck:
            test: ['CMD-SHELL', 'rabbitmq-diagnostics -q ping']
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - backend

    api:
        build:
            context: .
            dockerfile: ee/Dockerfile
        command: sh /app/start.sh
        environment:
            - DB_HOST=db
            - DB_PORT=5432
            - DB_USER=${POSTGRES_USER:-postgres}
            - DB_PASSWORD=${POSTGRES_PASSWORD}
            - DB_NAME=${POSTGRES_DB:-skald2}
            - IS_SELF_HOSTED_DEPLOY=true
            - LLM_PROVIDER=${LLM_PROVIDER:-openai}
            - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
            - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
            - OPENAI_API_KEY=${OPENAI_API_KEY:-}
            - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
            - GROQ_API_KEY=${GROQ_API_KEY:-}
            - GEMINI_API_KEY=${GEMINI_API_KEY:-}
            - LOCAL_LLM_BASE_URL=${LOCAL_LLM_BASE_URL:-}
            - LOCAL_LLM_MODEL=${LOCAL_LLM_MODEL:-}
            - SECRET_KEY=${SECRET_KEY}
            - FRONTEND_URL=https://${UI_DOMAIN}
            - API_URL=https://${API_DOMAIN}
            - INTER_PROCESS_QUEUE=rabbitmq
            - RABBITMQ_HOST=rabbitmq
            - RABBITMQ_PORT=5672
            - RABBITMQ_USER=${RABBITMQ_USER:-skald}
            - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-skald}
            - RABBITMQ_VHOST=/
            - SECURE_SSL_REDIRECT=false
            - EXPRESS_SERVER_PORT=8000
            - EMBEDDING_SERVICE_URL=http://embedding-service:8000 # this only applies if EMBEDDING_PROVIDER=local
            - DOCUMENT_EXTRACTION_PROVIDER=${DOCUMENT_EXTRACTION_PROVIDER:-docling}
            - DOCLING_SERVICE_URL=http://docling-serve:5001
            - LANGSMITH_TRACING=${LANGSMITH_TRACING:-false}
            - LANGSMITH_ENDPOINT=${LANGSMITH_ENDPOINT:-}
            - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
            - LANGSMITH_PROJECT=${LANGSMITH_PROJECT:-}
            - DATALAB_API_KEY=${DATALAB_API_KEY:-}
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
            - AWS_REGION=${AWS_REGION:-}
            - S3_BUCKET_NAME=${S3_BUCKET_NAME:-}
        depends_on:
            db:
                condition: service_healthy
            rabbitmq:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - web
            - backend
        labels:
            - 'traefik.enable=true'
            - 'traefik.http.routers.api.rule=Host(`${API_DOMAIN}`)'
            - 'traefik.http.routers.api.entrypoints=websecure'
            - 'traefik.http.routers.api.tls.certresolver=letsencrypt'
            - 'traefik.http.services.api.loadbalancer.server.port=8000'

    memo-processing-server:
        build:
            context: .
            dockerfile: ee/Dockerfile
        command: node /app/backend/dist/index.js --mode=memo-processing-server
        environment:
            - DB_HOST=db
            - DB_PORT=5432
            - DB_USER=${POSTGRES_USER:-postgres}
            - DB_PASSWORD=${POSTGRES_PASSWORD}
            - DB_NAME=${POSTGRES_DB:-skald2}
            - IS_SELF_HOSTED_DEPLOY=true
            - LLM_PROVIDER=${LLM_PROVIDER:-openai}
            - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
            - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
            - OPENAI_API_KEY=${OPENAI_API_KEY:-}
            - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
            - GROQ_API_KEY=${GROQ_API_KEY:-}
            - GEMINI_API_KEY=${GEMINI_API_KEY:-}
            - LOCAL_LLM_BASE_URL=${LOCAL_LLM_BASE_URL:-}
            - LOCAL_LLM_MODEL=${LOCAL_LLM_MODEL:-}
            - INTER_PROCESS_QUEUE=rabbitmq
            - RABBITMQ_HOST=rabbitmq
            - RABBITMQ_PORT=5672
            - RABBITMQ_USER=${RABBITMQ_USER:-skald}
            - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-skald}
            - RABBITMQ_VHOST=/
            - SECRET_KEY=${SECRET_KEY}
            - EMBEDDING_SERVICE_URL=http://embedding-service:8000 # this only applies if EMBEDDING_PROVIDER=local
            - DOCUMENT_EXTRACTION_PROVIDER=${DOCUMENT_EXTRACTION_PROVIDER:-docling}
            - DOCLING_SERVICE_URL=http://docling-serve:5001
            - LANGSMITH_TRACING=${LANGSMITH_TRACING:-false}
            - LANGSMITH_ENDPOINT=${LANGSMITH_ENDPOINT:-}
            - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
            - LANGSMITH_PROJECT=${LANGSMITH_PROJECT:-}
            - DATALAB_API_KEY=${DATALAB_API_KEY:-}
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
            - AWS_REGION=${AWS_REGION:-}
            - S3_BUCKET_NAME=${S3_BUCKET_NAME:-}
        depends_on:
            db:
                condition: service_healthy
            rabbitmq:
                condition: service_healthy
        restart: unless-stopped
        networks:
            - backend

    ui:
        build:
            context: .
            dockerfile: ui.Dockerfile
            args:
                VITE_API_HOST: https://${API_DOMAIN}
                VITE_IS_SELF_HOSTED_DEPLOY: 'true'
                VITE_IS_LICENSED_DEPLOY: 'true'
        restart: unless-stopped
        networks:
            - web
        labels:
            - 'traefik.enable=true'
            - 'traefik.http.routers.ui.rule=Host(`${UI_DOMAIN}`)'
            - 'traefik.http.routers.ui.entrypoints=websecure'
            - 'traefik.http.routers.ui.tls.certresolver=letsencrypt'
            - 'traefik.http.services.ui.loadbalancer.server.port=80'

    docling-serve:
        image: quay.io/docling-project/docling-serve:latest
        environment:
            - DOCLING_SERVE_ENABLE_UI=0
        restart: unless-stopped
        networks:
            - backend
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:5001/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        profiles:
            - local

    embedding-service:
        build:
            context: ./embedding-service
        environment:
            - EMBEDDING_MODEL=${LOCAL_EMBEDDING_MODEL:-all-MiniLM-L6-v2}
            - RERANK_MODEL=${LOCAL_RERANK_MODEL:-cross-encoder/ms-marco-MiniLM-L-6-v2}
            - TARGET_DIMENSION=2048
        ports:
            - '8001:8000'
        profiles:
            - local
        restart: unless-stopped
        networks:
            - backend
volumes:
    postgres_data:
    rabbitmq_data:
    traefik-certificates:

networks:
    web:
        driver: bridge
    backend:
        driver: bridge
